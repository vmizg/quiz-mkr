<div
  class="flex flex-col xl:flex-row place-content-center gap-16 xl:gap-8 pb-12 w-full max-w-4xl xl:max-w-full"
  [style]="cssVars"
>
  <div class="flex flex-col gap-2 w-full xl:w-3/5">
    <app-card-header [loading]="loading" [visible]="!!quizTitle" icon="asterisk">
      <ng-container titleContent>
        <span>{{ quizTitle }}</span>
        <!-- <sl-color-picker *ngIf="quizTitle" value="{{ quizColor }}" no-format-toggle (sl-change)="handleColorChange($event)">
          {{ quizColor }}
        </sl-color-picker> -->
        <sl-icon-button
          name="pencil"
          label="Edit quiz"
          (click)="handleEditQuiz()"
          class="edit-quiz-button"
        ></sl-icon-button>
      </ng-container>
    </app-card-header>
    <sl-form (sl-submit)="handleAddQuestion($event)" #questionForm>
      <sl-card class="question-container" [class.edit-mode]="existingQuestion">
        <div slot="header" class="font-semibold">
          <sl-badge [type]="existingQuestion ? 'primary' : 'neutral'" class="mr-2" pill>{{
            questionIndex + 1
          }}</sl-badge>
          {{ existingQuestion ? 'Edit' : 'New' }} question
        </div>
        <div class="flex flex-col gap-4">
          <div class="flex flex-row items-start gap-2">
            <sl-textarea
              class="question-statement"
              autofocus
              name="title"
              aria-label="Question statement"
              (sl-input)="handleEdit()"
              (paste)="handlePaste($event)"
              required
            >
            </sl-textarea>
            <div class="question-image relative m-auto ml-4">
              <ng-container *ngIf="!imageLoading && !!image">
                <img [src]="image" />
                <div class="image-actions">
                  <sl-button (click)="uploader.click()" size="small" circle><sl-icon name="pencil"></sl-icon></sl-button>
                  <sl-button (click)="image = ''" size="small" circle><sl-icon name="x-lg"></sl-icon></sl-button>
                </div>
              </ng-container>
              <sl-icon-button class="image-upload" *ngIf="!loading && !imageLoading && !image" (click)="uploader.click()" name="image"></sl-icon-button>
              <sl-spinner class="image-spinner" *ngIf="imageLoading || loading"></sl-spinner>
            </div>
            <input hidden type="file" accept="image/*" (change)="handleUploadImage($event)" #uploader />
          </div>
          <div *ngFor="let option of counter(totalOptions); let i = index" class="option-row" #questionOptions>
            <sl-button
              style="width: 6rem"
              type="{{ correctToggle.checked ? 'success' : 'neutral' }}"
              [outline]="!correctToggle.checked"
              (click)="correctToggle.checked = !correctToggle.checked; handleEdit()"
            >
              <sl-icon *ngIf="!correctToggle.checked" name="x-circle" label="incorrect" outline style="font-size: 1rem">
              </sl-icon>
              <sl-icon
                *ngIf="correctToggle.checked"
                name="check-circle"
                label="correct"
                outline
                style="font-size: 1rem"
              >
              </sl-icon>
              <span class="ml-2">{{ alphabet[i] }}.</span>
              <input [name]="'correct-' + i" type="checkbox" #correctToggle hidden />
            </sl-button>
            <sl-input
              style="width: 100%"
              label="{{ i === 0 ? 'Options' : '' }}"
              (sl-input)="handleEdit()"
              [name]="'option-' + i"
              #optionInput
              required
            ></sl-input>
            <sl-button
              style="width: 4rem"
              (click)="handleRemoveOption(optionInput)"
              [disabled]="totalOptions < 3"
              type="neutral"
              outline
              tabindex="-1"
            >
              <sl-icon name="trash"></sl-icon>
            </sl-button>
          </div>
          <div class="option-row add-option" *ngIf="totalOptions < 7">
            <sl-button class="w-full" (click)="handleAddOption()">Add a new option</sl-button>
          </div>
          <div>
            <sl-input label="Note(-s)" name="answer-note" (sl-input)="handleEdit()"></sl-input>
          </div>
        </div>
      </sl-card>
      <sl-card>
        <div class="flex flex-row justify-between gap-4">
          <sl-button class="w-full" type="primary" submit>
            <sl-spinner *ngIf="adding" slot="prefix"></sl-spinner>
            {{
              adding
                ? existingQuestion
                  ? 'Saving...'
                  : 'Adding...'
                : existingQuestion
                ? 'Save question'
                : 'Add question'
            }}
          </sl-button>
          <sl-button *ngIf="existingQuestion" (click)="handleCancelEdit()" type="neutral">Cancel</sl-button>
        </div>
      </sl-card>
    </sl-form>
  </div>
  <div class="flex flex-col gap-2 w-full xl:w-2/5">
    <app-card-header title="Questions in quiz" icon="question-circle"> </app-card-header>
    <cdk-virtual-scroll-viewport
      itemSize="104"
      class="question-list-container"
      *ngIf="questions && questions.length > 0"
    >
      <div class="flex flex-col gap-2">
        <sl-card
          *cdkVirtualFor="let q of questions; let i = index"
          class="question-card"
          [class.edit-mode]="isEditing(q)"
          #targetQ
        >
          <div class="flex flex-row items-center justify-between gap-4 h-12">
            <div class="question-title">
              <sl-badge [type]="isEditing(q) ? 'primary' : 'neutral'" class="mr-2" pill>{{ i + 1 }}</sl-badge>
              <span>{{ q.title }}</span>
            </div>
            <div class="flex flex-row gap-2">
              <sl-button type="neutral" circle outline (click)="handleEditQuestion(q, targetQ)"
                ><sl-icon [name]="isEditing(q) ? 'x-lg' : 'pencil-square'"></sl-icon
              ></sl-button>
              <sl-button type="danger" circle outline (click)="handleDeleteQuestion(q)" tabindex="-1"
                ><sl-icon name="trash"></sl-icon
              ></sl-button>
            </div>
          </div>
        </sl-card>
      </div>
    </cdk-virtual-scroll-viewport>
    <sl-card *ngIf="!loading && (!questions || questions.length === 0)">
      <div class="flex flex-col text-gray-500">
        <span>You have not added any questions for this quiz yet.</span>
      </div>
    </sl-card>
  </div>
</div>
